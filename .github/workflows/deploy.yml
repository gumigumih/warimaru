name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«å®Ÿè¡Œ

permissions:
  contents: write # GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¿…è¦ãªæ¨©é™

jobs:
  version-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å…¨å±¥æ­´ã‚’å–å¾—

      - name: Get current version from package.json
        id: current-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "current_version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Get latest release tag
        id: latest-tag
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest tag: $LATEST_TAG"

      - name: Check if version was updated
        id: version-check
        run: |
          CURRENT_VERSION="${{ steps.current-version.outputs.current_version }}"
          LATEST_TAG="${{ steps.latest-tag.outputs.latest_tag }}"

          # ã‚¿ã‚°ã‹ã‚‰vãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»
          LATEST_VERSION=${LATEST_TAG#v}

          if [ "$CURRENT_VERSION" = "$LATEST_VERSION" ]; then
            echo "âŒ Version not updated! Current: $CURRENT_VERSION, Latest tag: $LATEST_VERSION"
            echo "Please update the version in package.json before deploying"
            exit 1
          else
            echo "âœ… Version updated! Current: $CURRENT_VERSION, Latest tag: $LATEST_VERSION"
          fi

      - name: Validate semantic versioning
        run: |
          VERSION="${{ steps.current-version.outputs.current_version }}"

          # ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã®å½¢å¼ãƒã‚§ãƒƒã‚¯ (x.y.z)
          if ! echo "$VERSION" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' > /dev/null; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Version must follow semantic versioning (x.y.z)"
            exit 1
          fi

          echo "âœ… Version format is valid: $VERSION"

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: version-check # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ãŸå¾Œã«ã®ã¿å®Ÿè¡Œ
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist # Viteã®ãƒ“ãƒ«ãƒ‰å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
          branch: gh-pages # ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã®ãƒ–ãƒ©ãƒ³ãƒ
          clean: true # ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤

      - name: Create CNAME file
        run: echo "warimaru.meggumi.com" > dist/CNAME

      - name: Deploy CNAME
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: gh-pages
          clean: false

  create-release:
    runs-on: ubuntu-latest
    needs: build-and-deploy # ãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã—ãŸå¾Œã«å®Ÿè¡Œ
    if: startsWith(github.ref, 'refs/tags/v') # ã‚¿ã‚°ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å…¨å±¥æ­´ã‚’å–å¾—

      - name: Get version from tag
        id: get_version
        run: |
          # ã‚¿ã‚°ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŠ½å‡º (v1.2.0 â†’ 1.2.0)
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "Tag: ${GITHUB_REF#refs/tags/}"

      - name: Generate release notes
        id: generate_notes
        run: |
          TAG="${{ steps.get_version.outputs.tag }}"

          # å‰å›ã®ã‚¿ã‚°ã‚’å–å¾—
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 $TAG^ 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "Previous tag: $PREVIOUS_TAG"
            # å‰å›ã‚¿ã‚°ã‹ã‚‰ã®å¤‰æ›´ã‚’å–å¾—
            CHANGES=$(git log --pretty=format:"- %s" $PREVIOUS_TAG..$TAG)
          else
            echo "First release"
            # åˆå›ãƒªãƒªãƒ¼ã‚¹ã®å ´åˆã¯å…¨å±¥æ­´ã‚’å–å¾—
            CHANGES=$(git log --pretty=format:"- %s")
          fi

          # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”Ÿæˆ
          echo "# ã‚ã‚Šã¾ã‚‹ v${{ steps.get_version.outputs.version }} ãƒªãƒªãƒ¼ã‚¹" > release_notes.md
          echo "" >> release_notes.md
          echo "## ğŸ¯ æ¦‚è¦" >> release_notes.md
          echo "ã“ã®ãƒªãƒªãƒ¼ã‚¹ã§ã¯ã€ä»¥ä¸‹ã®æ”¹å–„ã¨æ–°æ©Ÿèƒ½ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚Webãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã™ãã«ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚" >> release_notes.md
          echo "" >> release_notes.md
          echo "## âœ¨ æ–°æ©Ÿèƒ½" >> release_notes.md
          echo "- " >> release_notes.md
          echo "" >> release_notes.md
          echo "## ğŸš€ æ”¹å–„" >> release_notes.md
          echo "- " >> release_notes.md
          echo "" >> release_notes.md
          echo "## ğŸ› ãƒã‚°ä¿®æ­£" >> release_notes.md
          echo "- " >> release_notes.md
          echo "" >> release_notes.md
          echo "## ğŸ“ å‚è€ƒï¼šã‚³ãƒŸãƒƒãƒˆå±¥æ­´" >> release_notes.md
          echo "ä»¥ä¸‹ã®ã‚³ãƒŸãƒƒãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼ˆæ‰‹å‹•ã§ç·¨é›†ã—ã¦ãã ã•ã„ï¼‰ï¼š" >> release_notes.md
          echo "" >> release_notes.md
          echo "$CHANGES" >> release_notes.md
          echo "" >> release_notes.md
          echo "## ğŸŒ ã‚¢ã‚¯ã‚»ã‚¹" >> release_notes.md
          echo "[ã‚ã‚Šã¾ã‚‹ v${{ steps.get_version.outputs.version }}](https://warimaru.meggumi.com)" >> release_notes.md
          echo "" >> release_notes.md
          echo "## ğŸ“‹ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯" >> release_notes.md
          echo "[GitHub Issues](https://github.com/gumigumih/warimaru/issues) ã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ã€‚" >> release_notes.md
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "**ğŸ“ æ‰‹å‹•ç·¨é›†å¾Œã«å…¬é–‹ã—ã¦ãã ã•ã„**" >> release_notes.md

          echo "Release notes generated"

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          release_name: ã‚ã‚Šã¾ã‚‹ v${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          draft: true # ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ä½œæˆï¼ˆæ‰‹å‹•ç·¨é›†å¾Œã«å…¬é–‹ï¼‰
          prerelease: false

      - name: Success message
        run: |
          echo "ğŸ‰ GitHubãƒªãƒªãƒ¼ã‚¹ v${{ steps.get_version.outputs.version }} ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼"
          echo "ğŸ“– ãƒ‰ãƒ©ãƒ•ãƒˆãƒªãƒªãƒ¼ã‚¹: https://github.com/gumigumih/warimaru/releases/tag/${{ steps.get_version.outputs.tag }}"
          echo ""
          echo "ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
          echo "1. ä¸Šè¨˜ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ãƒ‰ãƒ©ãƒ•ãƒˆãƒªãƒªãƒ¼ã‚¹ã‚’é–‹ã"
          echo "2. ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’æ‰‹å‹•ã§ç·¨é›†"
          echo "3. ç·¨é›†å®Œäº†å¾Œã€ŒPublish releaseã€ã§å…¬é–‹"
          echo ""
          echo "ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ãŒå‚è€ƒç”¨ã«å«ã¾ã‚Œã¦ã„ã¾ã™"
